name: Build & Deploy Qt6 App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install Qt 6 (x64)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.3'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          
      - name: Setup MSVC env
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure with qmake
        run: qmake -r

      - name: Build with nmake
        run: nmake /f Makefile.Release
        shell: cmd

      - name: Prepare Windows deploy
        shell: pwsh
        run: |
          mkdir deploy
          Copy-Item .\release\SyntaxTutor.exe deploy\
          windeployqt --release .\deploy\SyntaxTutor.exe --dir deploy

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-deploy
          path: deploy

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Instalar dependencias Qt6
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git wget ca-certificates file patchelf \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools \
            qt6-svg-dev libxkbcommon-x11-0 libxcb-xinerama0
          
      - name: Configure with qmake
        run: |
          qmake6 -r

      - name: Build
        run: |
          make -j$(nproc)

      - name: Generate AppImage
        run: |
          export APPIMAGE_EXTRACT_AND_RUN=1
          export LD_VER=continuous
          APPDIR=SyntaxTutor.AppDir
          
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/${LD_VER}/linuxdeploy-x86_64.AppImage \
            -O /usr/local/bin/linuxdeploy && \
          chmod +x /usr/local/bin/linuxdeploy && \
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/${LD_VER}/linuxdeploy-plugin-qt-x86_64.AppImage \
          -O /usr/local/bin/linuxdeploy-plugin-qt && \
          chmod +x /usr/local/bin/linuxdeploy-plugin-qt

          mkdir -p $APPDIR/usr/bin \
             $APPDIR/usr/share/icons/hicolor/256x256/apps
          
          cp SyntaxTutor $APPDIR/usr/bin/ && \
            printf '[Desktop Entry]\nType=Application\nIcon=syntaxtutor\nName=SyntaxTutor\nExec=SyntaxTutor\nCategories=Education;\n' > $APPDIR/SyntaxTutor.desktop && \
            chmod +x $APPDIR/SyntaxTutor.desktop && \
            install -Dm644 resources/syntaxtutor.png \
            $APPDIR/usr/share/icons/hicolor/256x256/apps/syntaxtutor.png && \
            /usr/local/bin/linuxdeploy \
              --appdir $APPDIR \
              --desktop-file $APPDIR/SyntaxTutor.desktop \
              --icon-file $APPDIR/usr/share/icons/hicolor/256x256/apps/syntaxtutor.png \
              --plugin qt \
              --output appimage


      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: '*.AppImage'
