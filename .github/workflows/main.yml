name: Build & Deploy Qt6 App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install Qt 6 (x64)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.0'
          host: windows
          target: desktop
          arch: x64

      - name: Configure with qmake
        run: qmake -r

      - name: Build with nmake
        run: nmake /f Makefile.Release

      - name: Prepare Windows deploy
        run: |
          mkdir deploy
          windeployqt --release .\SyntaxTutor.exe --dir deploy
          powershell Compress-Archive -Path deploy\* -DestinationPath deploy.zip

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-deploy
          path: deploy.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Instalar dependencias Qt6
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qt6-base-dev qt6-tools-dev-tools \
            libxcb-xinerama0-dev libglu1-mesa-dev
      - name: Select Qt6 system-wide
        run: |
          qtchooser -install qt6 $(which qmake6)
          sudo mv ~/.config/qtchooser/qt6.conf /usr/share/qtchooser/qt6.conf
          sudo mkdir -p /usr/lib/$(uname -p)-linux-gnu/qt-default/qtchooser
          sudo ln -n /usr/share/qtchooser/qt6.conf /usr/lib/$(uname -p)-linux-gnu/qt-default/qtchooser/default.conf
          
      - name: Configure with qmake
        run: |
          qmake -r

      - name: Build
        run: |
          make -j$(nproc)

      - name: Generate AppImage
        run: |
          # Crea la estructura AppDir
          APPDIR=MyApp.AppDir
          mkdir -p $APPDIR/usr/bin
          cp ./SyntaxTutor $APPDIR/usr/bin/SyntaxTutor

          wget -qO linuxdeployqt.AppImage \
            https://github.com/linuxdeploy/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt.AppImage

          ./linuxdeployqt.AppImage $APPDIR/usr/bin/SyntaxTutor \
            -appimage \
            -unsupported-allow-new-glibc \
            -no-translations \
            -verbose=2

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: '*.AppImage'
